<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schedule Tribe Application | Jdx Print</title>
  <!-- Uploadcare removed: using local file inputs + Apps Script upload -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>html,body{font-family:'Inter',ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;}</style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    /* continuous CSS-only animations */
    @keyframes spin360 { to { transform: rotate(360deg); } }
    .spin360 { animation: spin360 1s linear infinite; }

    @keyframes stripeMove { 0% { background-position: 200% 0 } 100% { background-position: -200% 0 } }
    .stripes {
      width: 220px;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(99,102,241,0.15) 0%, rgba(59,130,246,0.25) 25%, rgba(34,197,94,0.15) 50%, rgba(59,130,246,0.25) 75%, rgba(99,102,241,0.15) 100%);
      background-size: 300% 100%;
      animation: stripeMove 1.6s linear infinite;
    }

    /* keep overlay content centered on small screens */
    #fullScreenOverlay { backdrop-filter: blur(2px); }
    /* Radio-pill group styling */
    .radio-pill{ display:inline-flex; align-items:center; gap:0.75rem; padding:0.5rem 1rem; border-radius:0.5rem; border:1px solid #e5e7eb; cursor:pointer; background:#f8fafc }
    .radio-pill input{ appearance:none; -webkit-appearance:none; width:1rem; height:1rem; border-radius:50%; border:2px solid #cbd5e1; display:inline-block; position:relative }
    .radio-pill input:checked{ border-color:transparent; background:linear-gradient(90deg,#10b981,#3b82f6); box-shadow:0 0 0 3px rgba(59,130,246,0.08) }
    .radio-pill.active{ background:linear-gradient(90deg,#34d399,#60a5fa); color:white; border-color:transparent }
    .radio-pill span{ font-weight:600 }
  </style>
</head>
<body class="bg-gradient-to-br from-green-100 via-white to-blue-100 min-h-screen py-10 px-4 font-sans">
  <header class="mb-8">
    <div class="flex flex-col items-center">
      <h1 class="text-4xl font-extrabold text-green-600 drop-shadow-2xl tracking-wide mb-2 animate-pulse">
        Jdx Print
      </h1>
      <!-- prominent back button -->
      <a href="index.html" role="button" title="Back to home" aria-label="Back to home"
         class="mb-4 inline-flex w-full sm:w-auto items-center justify-center gap-2 px-5 py-3 bg-gradient-to-r from-green-600 to-green-400 text-white font-bold rounded-2xl shadow-lg hover:from-green-700 hover:to-green-500 transform hover:scale-105 transition focus:outline-none focus:ring-4 focus:ring-green-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        <span class="text-sm sm:text-base">Back to Home</span>
      </a>
      <div class="w-24 h-1 bg-gradient-to-r from-green-400 via-green-600 to-blue-400 rounded-full mb-4"></div>
    </div>
    <p class="text-center text-2xl font-bold text-gray-800 mb-2">
      Schedule Tribe Certificate Application
    </p>
    <p class="text-center text-lg text-gray-600 mb-2">
      Fast, easy, and hassle-free document application.<br>
      <span class="italic text-green-700">Upload all required documents below.</span>
    </p>
  </header>
  <main>
    <div class="max-w-xl mx-auto p-6 bg-white rounded-2xl shadow-2xl border-l-8 border-blue-400">
      <form id="mainForm" class="space-y-4">

        <!-- progress bar + text (new) -->
        <div class="mb-4">
          <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
            <div id="progressBar" class="h-2 bg-gradient-to-r from-green-500 to-blue-500 w-0 transition-all duration-500"></div>
          </div>
          <div class="text-sm text-gray-600 mt-2 text-right" id="progressText">Question 1 of 11</div>
        </div>

        <!-- Step 1: Name -->
        <div class="form-step" data-step="1">
          <label class="block font-semibold">Kyrteng (Full Name):
            <input type="text" name="name" required class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-green-300">
            <input type="hidden" name="service" value="ST">
          </label>
        </div>

        <!-- Step 2: Date of Birth (single date input to match pan.html) -->
        <div class="form-step hidden" data-step="2">
          <label class="block font-semibold">Sngi Kha (DOB):
            <input type="text" id="dob" name="dob" placeholder="dd-mm-yyyy" required class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-green-300">
          </label>
        </div>
          <input type="hidden" name="payment_id" id="payment_id" />

        <!-- Step 3: Gender -->
        <div class="form-step hidden" data-step="3">
          <div class="font-semibold mb-2">Kynthei / Shynrang (Gender):</div>
          <div role="radiogroup" aria-label="Gender" class="flex gap-3">
            <label class="radio-pill" tabindex="0">
              <input type="radio" name="Gender" value="Male" required />
              <span>Shynrang (Male)</span>
            </label>
            <label class="radio-pill" tabindex="0">
              <input type="radio" name="Gender" value="Female" required />
              <span>Kynthei (Female)</span>
            </label>
          </div>
        </div>

        <!-- Step 4: Tribe -->
        <div class="form-step hidden" data-step="4">
          <div class="font-semibold mb-2">Jaitbynriew (Tribe):</div>
          <div role="radiogroup" aria-label="Tribe" class="flex flex-wrap gap-3">
            <label class="radio-pill" tabindex="0">
              <input type="radio" name="tribe" value="Khasi" required />
              <span>Khasi</span>
            </label>
            <label class="radio-pill" tabindex="0">
              <input type="radio" name="tribe" value="Jaintia" required />
              <span>Jaintia</span>
            </label>
            <label class="radio-pill" tabindex="0">
              <input type="radio" name="tribe" value="Garo" required />
              <span>Garo</span>
            </label>
            <label class="radio-pill" tabindex="0">
              <input type="radio" name="tribe" value="Other" required />
              <span>Other</span>
            </label>
          </div>

          <!-- Hidden input to appear when 'Other' is selected -->
          <div id="otherTribeWrapper" class="mt-2 hidden">
            <input type="text" name="tribe_other" placeholder="Please specify your tribe" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-green-300" />
          </div>
        </div>

        <!-- Step 5: Phone -->
        <div class="form-step hidden" data-step="5">
          <label class="block font-semibold">Phone Number Jongphi:
            <input type="tel" name="phone" required class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-green-300">
          </label>
        </div>

        <!-- dob input is the visible date field in Step 2 -->

        <!-- Steps 6-11: Each file input as its own step (added Example image above each input) -->
        <div class="form-step hidden" data-step="6">
          <div class="example-wrapper mb-2">
            <div class="text-xs text-gray-600 mb-1">Example</div>
            <div class="font-semibold mb-2">Dur Passport Photo:</div>
            <img loading="lazy" alt="Passport photo example" class="w-full max-w-xs rounded border" src="images/examples/passport_example.jpg">
          </div>
          <label class="flex items-center gap-3 font-semibold bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 cursor-pointer">
            <input type="file" name="passport_photo" accept="image/*" required />
          </label>
        </div>

        <div class="form-step hidden" data-step="7">
          <div class="example-wrapper mb-2">
            <div class="text-xs text-gray-600 mb-1">Example</div>
            <div class="font-semibold mb-2">Birth Certificate:</div>
            <img loading="lazy" alt="Birth certificate example" class="w-full max-w-xs rounded border" src="images/examples/birth.jpg">
          </div>
          <label class="flex items-center gap-3 font-semibold bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 cursor-pointer">
            <input type="file" name="birth_certificate" accept="image/*,.pdf" required />
          </label>
        </div>

        <div class="form-step hidden" data-step="8">
          <div class="example-wrapper mb-2">
            <div class="text-xs text-gray-600 mb-1">Example</div>
            <div class="font-semibold mb-2">Residential Certificate Rangbah Shnong (Village Headman Certificate):</div>
            <img loading="lazy" alt="Village headman certificate example" class="w-full max-w-xs rounded border" src="images/examples/residential.jpg">
          </div>
          <label class="flex items-center gap-3 font-semibold bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 cursor-pointer">
            <input type="file" name="village_headman" accept="image/*,.pdf" required />
          </label>
        </div>

        <div class="form-step hidden" data-step="9">
          <div class="example-wrapper mb-2">
            <div class="text-xs text-gray-600 mb-1">Example</div>
            <div class="font-semibold mb-2"> Epic Voter ID jongphi lane Mei / Pa (Front):</div>
            <img loading="lazy" alt="Parents front voter id" class="w-full max-w-xs rounded border" src="images/examples/voter front.jpg">
          </div>
          <label class="flex items-center gap-3 font-semibold bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 cursor-pointer">
            <input type="file" name="parents_epic" accept="image/*,.pdf" required />
          </label>
        </div>

        <div class="form-step hidden" data-step="10">
          <div class="example-wrapper mb-2">
            <div class="text-xs text-gray-600 mb-1">Example</div>
            <div class="font-semibold mb-2">Epic Voter ID jongphi lane ID Mei / Pa (Back):</div>
            <img loading="lazy" alt="Parents back voter id" class="w-full max-w-xs rounded border" src="images/examples/voter back.jpg">
          </div>
          <label class="flex items-center gap-3 font-semibold bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 cursor-pointer">
            <input type="file" name="parents_backepic" accept="image/*,.pdf" required />
          </label>
        </div>

        <div class="form-step hidden" data-step="11">
          <div class="example-wrapper mb-2">
            <div class="text-xs text-gray-600 mb-1">Example</div>
            <div class="font-semibold mb-2">Schedule Tribe Mei / Pa (Parent's Certificate):</div>
            <img loading="lazy" alt="Parents schedule tribe certificate example" class="w-full max-w-xs rounded border" src="images/examples/st.jpg">
          </div>
          <label class="flex items-center gap-3 font-semibold bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 cursor-pointer">
            <input type="file" name="parents_st" accept="image/*,.pdf" required />
          </label>
        </div>

        <!-- Step 12: Confirmation / Preview -->
        <div class="form-step hidden" data-step="12" id="confirmationStep" aria-live="polite">
          <h3 class="text-lg font-bold text-gray-800 mb-3">Sngewbha Pynthikna dei ne em? (Confirm your details):</h3>
          <div class="space-y-2 text-sm text-gray-700">
            <div><strong>Name:</strong> <span id="conf_name"></span></div>
            <div><strong>Date of Birth:</strong> <span id="conf_dob"></span></div>
            <div><strong>Gender:</strong> <span id="conf_gender"></span></div>
            <div><strong>Tribe:</strong> <span id="conf_tribe"></span></div>
            <div><strong>Phone:</strong> <span id="conf_phone"></span></div>
          </div>
          <div class="mt-4 flex gap-3">
                <button type="button" id="confEditBtn" class="px-4 py-2 rounded-full bg-white border text-gray-700">Edit</button>
                <button type="button" id="confProceedBtn" class="px-4 py-2 rounded-full bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold">Online Payment & Submit</button>
              </div>

          
        </div>

        <!-- Navigation area: Previous + Next + Submit/hidden until confirm -->
        <div class="mt-6 relative">
          <div class="flex items-center gap-3">
            <button type="button" id="prevBtn" class="flex-none hidden bg-white border text-gray-700 px-4 py-2 rounded-full shadow-sm">Previous</button>

            <button type="button" id="nextBtn" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-blue-600 hover:to-green-600 text-white font-bold px-4 py-2 rounded-full shadow-lg text-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-400">
              Next
            </button>

            <button type="submit" id="submitBtn" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-blue-600 hover:to-green-600 text-white font-bold px-4 py-2 rounded-full shadow-lg text-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-400 hidden">
              Submit Application
            </button>
          </div>

          <div id="loadingSpinner" class="absolute inset-0 flex items-center justify-center bg-white/50 rounded-full hidden">
            <div class="w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div>
          </div>
        </div>
      </form>
      <div id="thankYouMessage" style="display:none;" class="text-center mt-6 text-green-700 font-semibold">
        âœ… Form Submitted, thank you.<br>
        For further assistance contact our team: <a href="tel:9862189403" class="underline text-blue-700">9862189403</a>
      </div>

      <!-- Full-screen overlay for submit progress / countdown -->
      <div id="fullScreenOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 hidden">
        <div class="flex flex-col items-center justify-center h-full px-4">
          <!-- spinner uses CSS animation class by default (no JS start required) -->
          <div id="overlaySpinner" class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full spin360 mb-6"></div>
          <div class="stripes mb-4" aria-hidden="true"></div>
          <div id="overlayMessage" class="text-xl font-semibold text-gray-800 mb-2">Submitting your form, please wait...</div>
          <div id="overlaySub" class="text-sm text-gray-600 mb-4">This may take a few moments.</div>
          <div id="overlayCountdown" class="text-sm text-gray-700 mb-3 hidden">Redirecting in <span id="countdownTimer">60</span>s...</div>
          <div class="flex gap-3">
            <a href="index.html" id="overlayBackBtn" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-600 to-green-400 text-white rounded-2xl shadow hidden">Go to homepage</a>
            <button id="overlayCancelBtn" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-2xl shadow hidden">Close</button>
          </div>
        </div>
      </div>

      <div class="text-center mt-4">
        <a href="https://wa.me/9862189403" target="_blank" class="text-green-700 underline">ðŸ’¬ Need Help? Chat on WhatsApp</a>
      </div>
    </div>
    <!-- duplicate bottom back-to-home link removed; header back button remains -->
  </main>
    <script src="js/upload_to_gas.js"></script>

    <!-- Replaced script: label clicking, step logic and form submit -->
    <script>
      // Make labels focus file inputs (kept behavior)
      document.querySelectorAll('label[for], label > input[type="file"]').forEach(function(labelOrInput) {
        let label = labelOrInput.tagName === 'LABEL' ? labelOrInput : labelOrInput.parentElement;
        let input = label.querySelector('input[type="file"]');
        if (input) {
          label.addEventListener('click', function(e) {
            if (e.target !== input) {
              e.preventDefault();
              input.click();
            }
          });
        }
      });

      // Wizard step logic with progress bar, transitions, Prev, and confirmation
      (function(){
        const form = document.getElementById('mainForm');
        const steps = Array.from(document.querySelectorAll('.form-step'));
        const total = steps.length; // includes confirmation step
        let current = 0;
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // confirmation elements
        const confName = document.getElementById('conf_name');
        const confDob = document.getElementById('conf_dob');
        const confGender = document.getElementById('conf_gender');
        const confTribe = document.getElementById('conf_tribe');
        const confPhone = document.getElementById('conf_phone');
        const confProceedBtn = document.getElementById('confProceedBtn');
        const confEditBtn = document.getElementById('confEditBtn');

        function setProgress(index) {
          const pct = Math.round(((index + 1) / total) * 100);
          progressBar.style.width = pct + '%';
          progressText.textContent = `Question ${Math.min(index + 1, total - 1)} of ${total - 1}`; // show questions count excluding confirmation
        }

        function instantShow(index) {
          steps.forEach((s,i) => {
            if (i === index) {
              s.classList.remove('hidden');
              s.classList.remove('opacity-0','translate-x-6','-translate-x-6');
            } else {
              s.classList.add('hidden');
            }
          });
          // prev visibility (hide on first)
          if (index === 0) prevBtn.classList.add('hidden'); else prevBtn.classList.remove('hidden');

          // if we're on confirmation (last) hide Next and show confirmation internal buttons
          if (index === total - 1) {
            nextBtn.classList.add('hidden');
            submitBtn.classList.add('hidden');
            // populate confirmation
            populateConfirmation();
          } else {
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
          }
          setProgress(index);
        }

        function animateTransition(fromIndex, toIndex, forward = true) {
          const from = steps[fromIndex];
          const to = steps[toIndex];
          const dur = 300;

          if (from) {
            from.classList.add('transition-all','duration-300','ease-in-out');
            from.classList.add(forward ? '-translate-x-6' : 'translate-x-6');
            from.classList.add('opacity-0');
            setTimeout(() => {
              from.classList.add('hidden');
              from.classList.remove('transition-all','duration-300','ease-in-out','-translate-x-6','translate-x-6','opacity-0');
            }, dur);
          }

          if (to) {
            to.classList.remove('hidden');
            to.classList.add('opacity-0', forward ? 'translate-x-6' : '-translate-x-6');
            requestAnimationFrame(() => {
              to.classList.add('transition-all','duration-300','ease-in-out');
              to.classList.remove('opacity-0','translate-x-6','-translate-x-6');
            });
            setTimeout(() => {
              to.classList.remove('transition-all','duration-300','ease-in-out');
            }, dur + 50);
          }

          setTimeout(() => {
            // prev visibility
            if (toIndex === 0) prevBtn.classList.add('hidden'); else prevBtn.classList.remove('hidden');
            // if confirmation step
            if (toIndex === total - 1) {
              nextBtn.classList.add('hidden');
              submitBtn.classList.add('hidden');
              populateConfirmation();
            } else {
              nextBtn.classList.remove('hidden');
              submitBtn.classList.add('hidden');
            }
            setProgress(toIndex);
          }, dur);
        }

        function validateStep(index) {
          const step = steps[index];
          const controls = Array.from(step.querySelectorAll('input, select, textarea'));
          for (let ctrl of controls) {
            if (ctrl.type === 'file') {
              if (ctrl.hasAttribute('required') && (!ctrl.files || ctrl.files.length === 0)) {
                ctrl.focus();
                alert('Please upload the required file.');
                return false;
              }
            } else {
              if (!ctrl.checkValidity()) {
                ctrl.reportValidity();
                return false;
              }
            }
          }
          return true;
        }

        nextBtn.addEventListener('click', function(){
          if (!validateStep(current)) return;
          const nextIndex = Math.min(current + 1, total - 1);
          // if moving into confirmation, populate after animation
          animateTransition(current, nextIndex, true);
          current = nextIndex;
        });

        prevBtn.addEventListener('click', function(){
          if (current <= 0) return;
          const prevIndex = Math.max(current - 1, 0);
          animateTransition(current, prevIndex, false);
          current = prevIndex;
        });

        // populate confirmation with current values
        function populateConfirmation() {
          const name = (form.querySelector('input[name="name"]') || {}).value || '';
          const dobVal = (form.querySelector('input[name="dob"]') || {}).value || '';
          const gender = (form.querySelector('input[name="Gender"]:checked') || {}).value || '';
          let tribe = (form.querySelector('input[name="tribe"]:checked') || {}).value || '';
          if (tribe === 'Other') {
            const tOther = form.querySelector('input[name="tribe_other"]');
            if (tOther && tOther.value) tribe = tOther.value;
          }
          const phone = (form.querySelector('input[name="phone"]') || {}).value || '';

          // format dob (from YYYY-MM-DD to DD-MM-YYYY) for display
          let dobDisplay = '';
          if (dobVal) {
            const p = dobVal.split('-');
            if (p.length === 3) dobDisplay = `${p[2]}-${p[1]}-${p[0]}`;
            else dobDisplay = dobVal;
          }

          confName.textContent = name;
          confDob.textContent = dobDisplay;
          confGender.textContent = gender;
          confTribe.textContent = tribe;
          confPhone.textContent = phone;
        }

        // Confirmation buttons
        confProceedBtn.addEventListener('click', function(){
          // trigger payment flow which will submit on success
          payAndSubmit();
        });


        confEditBtn.addEventListener('click', function(){
          // jump back to first step for editing (keeping values)
          const target = 0;
          animateTransition(current, target, false);
          current = target;
        });

        // initial
        instantShow(0);
      })();

    // Payment + submit (uses same Razorpay flow as pan.html)  
    function payAndSubmit() {
      const form = document.getElementById('mainForm');
      const btn = document.getElementById('confProceedBtn');
      if (!form.checkValidity()) { form.reportValidity(); return; }

      // quick required-file check to avoid charging then failing
      const requiredFiles = Array.from(form.querySelectorAll('input[type="file"][required]'));
      const missingFiles = requiredFiles.filter(f => !f.files || f.files.length === 0);
      if (missingFiles.length) { alert('Please upload all required files before proceeding.'); missingFiles[0].focus(); return; }

      // ensure dob present
      const dobVal = (form.querySelector('input[name="dob"]') || {}).value || '';
      if (!dobVal.trim()) { alert('Please enter Date of Birth.'); (form.querySelector('input[name="dob"]')||{}).focus(); return; }

      const options = {
        key: "rzp_live_90jFdMHiP0Rtcz",
        amount: 25000,
        currency: "INR",
        name: "Schedule Tribe Application",
        description: "Schedule Tribe Processing Fee",
        handler: function(response) {
          try {
            if (response && response.razorpay_payment_id) {
              const pid = document.getElementById('payment_id'); if (pid) pid.value = response.razorpay_payment_id;
            }
            if (btn) { btn.disabled = true; btn.textContent = 'Processing...'; }
            if (typeof toggleSpinner === 'function') toggleSpinner(form, true);
            // submit form (existing submit handler will attach CSV and run upload)
            form.requestSubmit();
          } catch (ex) {
            alert('Unexpected error: ' + ex);
            if (btn) { btn.disabled = false; btn.textContent = 'Pay â‚¹200 & Submit'; }
            if (typeof toggleSpinner === 'function') toggleSpinner(form, false);
          }
        },
        theme: { color: "#4CAF50" }
      };
      const rzp = new Razorpay(options);
      rzp.open();
    }

      // existing submit handler (kept, only minor reference fixes)
      document.getElementById('mainForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Read DOB from single date input (YYYY-MM-DD)
        var dobInput = document.getElementById('dob');
        var dobVal = dobInput ? dobInput.value : '';
        if (!dobVal) {
          alert('Please select Date of Birth.');
          return false;
        }

        // --- NEW: create CSV and attach as a file input named "details_csv" ---
        (function attachCSVToForm(formEl){
          try {
            const name = (formEl.querySelector('input[name="name"]') || {}).value || '';
            const gender = (formEl.querySelector('input[name="Gender"]:checked') || {}).value || '';
            let tribe = (formEl.querySelector('input[name="tribe"]:checked') || {}).value || '';
            if (tribe === 'Other') {
              const tOther = formEl.querySelector('input[name="tribe_other"]');
              tribe = tOther && tOther.value ? tOther.value : tribe;
            }
            const phone = (formEl.querySelector('input[name="phone"]') || {}).value || '';

            // convert YYYY-MM-DD to DD-MM-YYYY for CSV
            const dobValInner = (formEl.querySelector('input[name="dob"]') || {}).value || '';
            let dobCombined = dobValInner;
            if (dobValInner && dobValInner.split('-').length === 3) {
              const p = dobValInner.split('-');
              dobCombined = `${p[2]}-${p[1]}-${p[0]}`;
            }
            const header = ['Name','Date of Birth (Day-month-Year)','Gender','Tribe','Phone'].join(',');
            // Escape double quotes in values
            function esc(v){ return `"${String(v).replace(/"/g,'""')}"`; }
            const row = [name, dobCombined, gender, tribe, phone].map(esc).join(',');
            const csv = header + '\n' + row;

            const csvFile = new File([csv], 'details.csv', { type: 'text/csv' });

            // create or reuse hidden file input and attach the File via DataTransfer
            let csvInput = formEl.querySelector('input[name="details_csv"]');
            if (!csvInput) {
              csvInput = document.createElement('input');
              csvInput.type = 'file';
              csvInput.name = 'details_csv';
              csvInput.style.display = 'none';
              formEl.appendChild(csvInput);
            }
            const dt = new DataTransfer();
            dt.items.add(csvFile);
            csvInput.files = dt.files;
          } catch (err) {
            console.warn('CSV attach failed:', err);
          }
        })(this);
        // --- end NEW ---

        // List all required upload input names here
        const requiredUploads = [
          'passport_photo',
          'birth_certificate',
          'village_headman',
          'parents_epic',
          'parents_backepic',
          'parents_st'
        ];
        let missing = [];
        requiredUploads.forEach(function(name) {
          const input = document.querySelector('input[name="' + name + '"]');
          if (!input || !input.files || input.files.length === 0) missing.push(name.replace(/_/g, ' '));
        });
        if (missing.length > 0) {
          alert('Please upload the following documents before submitting:\n\n' + missing.join('\n'));
          return false;
        } else {
          // Show small loading spinner (existing) and also full-screen overlay
          document.getElementById('loadingSpinner').classList.remove('hidden');

          // Disable submit & next to prevent double submissions
          const submitBtn = document.getElementById('submitBtn');
          const nextBtn = document.getElementById('nextBtn');
          submitBtn.setAttribute('disabled','disabled');
          submitBtn.classList.add('opacity-50','cursor-not-allowed');
          nextBtn.setAttribute('disabled','disabled');
          nextBtn.classList.add('opacity-50','cursor-not-allowed');

          // Show full-screen overlay
          const overlay = document.getElementById('fullScreenOverlay');
          const overlaySpinner = document.getElementById('overlaySpinner');
          const overlayMessage = document.getElementById('overlayMessage');
          const overlaySub = document.getElementById('overlaySub');
          const overlayCountdown = document.getElementById('overlayCountdown');
          const countdownTimerEl = document.getElementById('countdownTimer');
          const overlayBackBtn = document.getElementById('overlayBackBtn');
          overlay.classList.remove('hidden');
          overlayMessage.textContent = 'Submitting your form, please wait...';
          overlaySub.textContent = 'Do not close this window.';
          // spinner is CSS-animated by default (spin360 class in markup) - no JS add required
          overlayCountdown.classList.add('hidden');
          // ensure back button hidden during submit
          overlayBackBtn.classList.add('hidden');

          // Safety max wait (ms) before treating as timeout
          const MAX_WAIT_MS = 120000; // 2 minutes
          let finished = false;
          let maxWaitHandle = setTimeout(() => {
            if (!finished) handleFinish({ timeout: true, message: 'Submission timeout.' });
          }, MAX_WAIT_MS);

          // shared finish handler
          function handleFinish(result) {
            if (finished) return;
            finished = true;
            clearTimeout(maxWaitHandle);
            // stop small spinner
            document.getElementById('loadingSpinner').classList.add('hidden');
            // stop overlay spinner animation by removing CSS class
            overlaySpinner.classList.remove('spin360');

            // show appropriate message
            if (result && result.resp && result.resp.success) {
              overlayMessage.textContent = 'Submission completed successfully.';
              overlaySub.textContent = 'Thank you. You will be redirected shortly.';
              document.getElementById('thankYouMessage').style.display = 'block';
              document.getElementById('mainForm').style.display = 'none';
              // reveal Go to homepage only on successful submission
              overlayBackBtn.classList.remove('hidden');
            } else if (result && result.err) {
              overlayMessage.textContent = 'Submission failed.';
              overlaySub.textContent = 'Error: ' + String(result.err).slice(0,200);
              // do NOT show go-home on failure (per requirement)
              overlayBackBtn.classList.add('hidden');
            } else if (result && result.timeout) {
              overlayMessage.textContent = 'Submission timeout.';
              overlaySub.textContent = 'Upload did not finish in time.';
              overlayBackBtn.classList.add('hidden');
            } else {
              overlayMessage.textContent = 'Submission completed.';
              overlaySub.textContent = '';
              overlayBackBtn.classList.add('hidden');
            }

            // start 60s countdown to redirect
            let remaining = 60;
            countdownTimerEl.textContent = remaining;
            overlayCountdown.classList.remove('hidden');

            const countdownInterval = setInterval(() => {
              remaining -= 1;
              countdownTimerEl.textContent = remaining;
              if (remaining <= 0) {
                clearInterval(countdownInterval);
                window.location.href = 'index.html';
              }
            }, 1000);

            // keep submit disabled to avoid re-submission
          }

          // call upload (existing)
          uploadFormToGAS(this).then(resp => {
            handleFinish({ resp: resp });
          }).catch(err => {
            handleFinish({ err: err });
          });

        }
      });
    </script>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const fp = flatpickr("#dob", {
      allowInput: true,
      altInput: true,
      altFormat: "d-m-Y",
      dateFormat: "Y-m-d",
      maxDate: "today",
      disableMobile: false // true = always use flatpickr, false = use native on mobile (scroll wheel)
    });

    // Auto-insert dashes while typing (dd-mm-yyyy). Attach to visible input (altInput when present).
    (function enableAutoDash(fpInstance){
      const visible = (fpInstance && fpInstance.altInput) ? fpInstance.altInput : fpInstance.input;
      if (!visible) return;
      visible.setAttribute('maxlength','10');
      visible.addEventListener('input', function onInput() {
        const raw = visible.value || '';
        const digits = raw.replace(/\D/g,'').slice(0,8); // ddmmyyyy
        let parts = [];
        if (digits.length > 0) parts.push(digits.slice(0,2));
        if (digits.length > 2) parts.push(digits.slice(2,4));
        if (digits.length > 4) parts.push(digits.slice(4,8));
        const formatted = parts.join('-');
        // Only set if different to avoid caret jumps where possible
        if (visible.value !== formatted) visible.value = formatted;

        // When full date entered (8 digits) try to update flatpickr's date (ISO)
        if (digits.length === 8) {
          const d = formatted.split('-');
          if (d.length === 3) {
            const iso = `${d[2]}-${d[1]}-${d[0]}`;
            try { fpInstance.setDate(iso, true); } catch (e) { /* ignore invalid */ }
          }
        }
      });
    })(fp);
  </script>
  <script>
  (function(){
    const otherWrapper = document.getElementById('otherTribeWrapper');
    function updateOtherVisibility(){
      const sel = document.querySelector('input[name="tribe"]:checked');
      if (sel && sel.value === 'Other') otherWrapper.classList.remove('hidden'); else otherWrapper.classList.add('hidden');
    }

    function updatePills(name){
      const inputs = Array.from(document.querySelectorAll('input[name="'+name+'"]'));
      inputs.forEach(i => {
        const lab = i.closest('label') || i.parentElement;
        if (!lab) return;
        if (i.checked) lab.classList.add('active'); else lab.classList.remove('active');
      });
    }

    // attach change listeners
    Array.from(document.querySelectorAll('input[name="tribe"]')).forEach(function(r){
      r.addEventListener('change', function(){ updateOtherVisibility(); updatePills('tribe'); });
    });
    Array.from(document.querySelectorAll('input[name="Gender"]')).forEach(function(r){
      r.addEventListener('change', function(){ updatePills('Gender'); });
    });

    // keyboard support for pill labels (Enter/Space)
    Array.from(document.querySelectorAll('.radio-pill')).forEach(function(lbl){
      lbl.addEventListener('keydown', function(e){
        if (e.key === ' ' || e.key === 'Enter'){
          e.preventDefault();
          const inp = lbl.querySelector('input'); if (inp){ inp.checked = true; inp.dispatchEvent(new Event('change',{bubbles:true})); }
        }
      });
    });

    // initialize states on load
    updateOtherVisibility(); updatePills('tribe'); updatePills('Gender');
  })();
</script>

</body>
</html>
